{% extends "base.html" %}
{% load static %}
{% load custom_filters %}

{% block title %}–ö–æ—Ä–∑–∏–Ω–∞ ‚Äî Clean Store{% endblock %}

{% block content %}
<div class="cart-page">
    <div class="container">
        <!-- –•–ª–µ–±–Ω—ã–µ –∫—Ä–æ—à–∫–∏ -->
        <nav class="breadcrumb">
            <a href="{% url 'home' %}" class="breadcrumb-link">–ì–ª–∞–≤–Ω–∞—è</a>
            <span class="breadcrumb-separator">‚Üí</span>
            <a href="{% url 'appProducts:category_list' %}" class="breadcrumb-link">–ö–∞—Ç–∞–ª–æ–≥</a>
            <span class="breadcrumb-separator">‚Üí</span>
            <span class="breadcrumb-current">–ö–æ—Ä–∑–∏–Ω–∞</span>
        </nav>

        <!-- –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ -->
        <div class="cart-header-modern">
            <div class="cart-title-section">
                <h1 class="cart-title-modern">üõí –ö–æ—Ä–∑–∏–Ω–∞ –ø–æ–∫—É–ø–æ–∫</h1>
                <p class="cart-subtitle">–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–∞—à–∏ —Ç–æ–≤–∞—Ä—ã –ø–µ—Ä–µ–¥ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ–º –∑–∞–∫–∞–∑–∞</p>
            </div>
            <div class="cart-actions-header">
                <a href="{% url 'appProducts:category_list' %}" class="continue-shopping-btn">
                    <span class="btn-icon">üîô</span>
                    <span class="btn-text">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø–æ–∫—É–ø–∫–∏</span>
                </a>
                <button class="clear-cart-btn" onclick="clearCart()">
                    <span class="btn-icon">üóëÔ∏è</span>
                    <span class="btn-text">–û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É</span>
                </button>
            </div>
        </div>

        {% if cart_items %}
            <div class="cart-content-modern">
                <!-- –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã –≤ –∫–æ—Ä–∑–∏–Ω–µ -->
                <div class="cart-items-modern">
                    {% for item in cart_items %}
                        <div class="cart-item-modern" data-item-id="{{ item.id }}">
                            <div class="item-checkbox">
                                <input type="checkbox" id="item-{{ item.id }}" class="item-select" checked>
                                <label for="item-{{ item.id }}" class="checkbox-label"></label>
                            </div>
                            
                            <div class="item-image-modern">
                                {% if item.product.main_image %}
                                    <img src="{{ item.product.main_image.url }}" alt="{{ item.product.name }}" class="product-image">
                                {% else %}
                                    <div class="image-placeholder-modern">
                                        <span class="placeholder-icon">üßπ</span>
                                    </div>
                                {% endif %}
                                
                                <!-- –ë–µ–π–¥–∂–∏ —Ç–æ–≤–∞—Ä–∞ -->
                                <div class="item-badges">
                                    {% if item.product.is_new %}
                                        <span class="item-badge new">‚ú®</span>
                                    {% endif %}
                                    {% if item.product.is_hit %}
                                        <span class="item-badge hit">üî•</span>
                                    {% endif %}
                                    {% if item.product.is_sale %}
                                        <span class="item-badge sale">üí∞</span>
                                {% endif %}
                                </div>
                            </div>
                            
                            <div class="item-info-modern">
                                <div class="item-header">
                                    <h3 class="item-name-modern">{{ item.product.name }}</h3>
                                    <button class="item-remove-btn" onclick="removeItem({{ item.id }})" title="–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä">
                                        <span class="remove-icon">√ó</span>
                                    </button>
                                </div>
                                
                                <div class="item-category-modern">
                                    <span class="category-icon">üìÇ</span>
                                    <span class="category-path">{{ item.product.subcategory.category.title }} ‚Üí {{ item.product.subcategory.title }}</span>
                                </div>
                                
                                <div class="item-description">
                                    <p>{{ item.product.description|default:"–ö–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–π —Ç–æ–≤–∞—Ä –¥–ª—è –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–π —É–±–æ—Ä–∫–∏"|truncatewords:12 }}</p>
                                </div>
                                
                                <div class="item-meta">
                                    <span class="item-sku">–ê—Ä—Ç–∏–∫—É–ª: SP-{{ item.product.id|stringformat:"04d" }}</span>
                                    <span class="item-availability">‚úÖ –í –Ω–∞–ª–∏—á–∏–∏</span>
                                </div>
                            </div>
                            
                            <div class="item-controls-modern">
                                <div class="price-section">
                                    <div class="unit-price">
                                        <span class="price-label">–¶–µ–Ω–∞ –∑–∞ –µ–¥–∏–Ω–∏—Ü—É:</span>
                                        <span class="price-value">{{ item.product.price|currency }}</span>
                                    </div>
                            </div>
                            
                                <div class="quantity-section-modern">
                                    <label class="quantity-label-modern">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</label>
                                    <div class="quantity-controls-modern">
                                        <button type="button" class="qty-btn-modern minus" onclick="updateQuantity({{ item.id }}, -1)">
                                            <span>‚àí</span>
                                        </button>
                                        <input type="number" 
                                               value="{{ item.quantity }}" 
                                               min="1" 
                                               max="100" 
                                               class="qty-input-modern" 
                                               id="qty-{{ item.id }}"
                                               onchange="updateQuantityInput({{ item.id }}, this.value)">
                                        <button type="button" class="qty-btn-modern plus" onclick="updateQuantity({{ item.id }}, 1)">
                                            <span>+</span>
                                        </button>
                                    </div>
                            </div>
                            
                                <div class="total-section">
                                    <div class="total-price-modern">
                                        <span class="total-label-modern">–ò—Ç–æ–≥–æ:</span>
                                        <span class="total-value" id="total-{{ item.id }}">{{ item.product.price|multiply:item.quantity|currency }}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="item-actions-modern">
                                <button class="action-btn-item wishlist" onclick="toggleWishlist({{ item.product.id }}, this)" title="–í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ">
                                    <span class="action-icon">‚ù§Ô∏è</span>
                                </button>
                                <button class="action-btn-item save-later" onclick="saveForLater({{ item.id }})" title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞ –ø–æ—Ç–æ–º">
                                    <span class="action-icon">üìå</span>
                                </button>
                                <a href="{% url 'appProducts:product_detail' item.product.subcategory.category.slug item.product.subcategory.slug item.product.slug %}" 
                                   class="action-btn-item view-product" title="–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ç–æ–≤–∞—Ä">
                                    <span class="action-icon">üëÅÔ∏è</span>
                                </a>
                            </div>
                        </div>
                    {% endfor %}
                </div>

                <!-- –°–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –∏—Ç–æ–≥–æ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                <div class="cart-summary-modern">
                    <div class="summary-card-modern">
                        <div class="summary-header">
                            <h3>üí∞ –ò—Ç–æ–≥–∏ –∑–∞–∫–∞–∑–∞</h3>
                            <div class="summary-badge">–û–±–Ω–æ–≤–ª–µ–Ω–æ</div>
                        </div>
                        
                        <div class="summary-content">
                            <div class="summary-line-modern">
                                <div class="line-info">
                                    <span class="line-icon">üì¶</span>
                                    <span class="line-text">–¢–æ–≤–∞—Ä–æ–≤ –≤ –∫–æ—Ä–∑–∏–Ω–µ</span>
                                </div>
                                <span class="line-value" id="total-items">{{ cart_items.count }} —à—Ç.</span>
                            </div>
                            
                            <div class="summary-line-modern">
                                <div class="line-info">
                                    <span class="line-icon">üíµ</span>
                                    <span class="line-text">–°—Ç–æ–∏–º–æ—Å—Ç—å —Ç–æ–≤–∞—Ä–æ–≤</span>
                                </div>
                                <span class="line-value" id="subtotal">{{ total|currency }}</span>
                            </div>
                            
                            <div class="delivery-section">
                                <div class="summary-line-modern">
                                    <div class="line-info">
                                        <span class="line-icon">üöö</span>
                                        <span class="line-text">–î–æ—Å—Ç–∞–≤–∫–∞</span>
                                    </div>
                                    <span class="line-value free">–ë–µ—Å–ø–ª–∞—Ç–Ω–æ</span>
                                </div>
                                <div class="delivery-note">
                                    –ü—Ä–∏ –∑–∞–∫–∞–∑–µ –æ—Ç 1000 ‚ÇΩ –¥–æ—Å—Ç–∞–≤–∫–∞ –ø–æ –ú–æ—Å–∫–≤–µ –±–µ—Å–ø–ª–∞—Ç–Ω–∞—è
                                </div>
                        </div>
                        
                            <div class="discount-section">
                                <div class="discount-input-group">
                                    <input type="text" 
                                           placeholder="–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥" 
                                           class="promo-input" 
                                           id="promoCode">
                                    <button class="promo-btn" onclick="applyPromoCode()">
                                        <span>–ü—Ä–∏–º–µ–Ω–∏—Ç—å</span>
                                    </button>
                                </div>
                        </div>
                        
                            <div class="summary-divider"></div>
                            
                            <div class="summary-line-modern total-line">
                                <div class="line-info">
                                    <span class="line-icon">üíé</span>
                                    <span class="line-text">–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ</span>
                                </div>
                                <span class="line-value total-amount" id="final-total">{{ total|currency }}</span>
                        </div>
                        
                            <div class="payment-methods">
                                <div class="payment-title">–°–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã:</div>
                                <div class="payment-icons">
                                    <span class="payment-icon" title="–ë–∞–Ω–∫–æ–≤—Å–∫–∏–µ –∫–∞—Ä—Ç—ã">üí≥</span>
                                    <span class="payment-icon" title="–ù–∞–ª–∏—á–Ω—ã–µ">üíµ</span>
                                    <span class="payment-icon" title="–ü–µ—Ä–µ–≤–æ–¥">üè¶</span>
                                    <span class="payment-icon" title="–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–µ –∫–æ—à–µ–ª—å–∫–∏">üì±</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="summary-actions-modern">
                            <button class="select-all-btn" onclick="toggleSelectAll()">
                                <span class="btn-icon">‚òëÔ∏è</span>
                                <span class="btn-text">–í—ã–¥–µ–ª–∏—Ç—å –≤—Å–µ</span>
                            </button>
                            
                            <a href="{% url 'appProducts:checkout' %}" class="checkout-btn-modern">
                                <span class="checkout-icon">üí≥</span>
                                <div class="checkout-content">
                                    <span class="checkout-text">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</span>
                                    <span class="checkout-amount">{{ total|currency }}</span>
                                </div>
                                <span class="checkout-arrow">‚Üí</span>
                            </a>
                            
                            <div class="security-note">
                                <span class="security-icon">üîí</span>
                                <span class="security-text">–ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ–ø–ª–∞—Ç–∞ SSL</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ -->
                    <div class="cart-benefits">
                        <div class="benefit">
                            <span class="benefit-icon">üöö</span>
                            <div class="benefit-text">
                                <strong>–ë—ã—Å—Ç—Ä–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞</strong>
                                <p>1-3 –¥–Ω—è –ø–æ –†–æ—Å—Å–∏–∏</p>
                            </div>
                        </div>
                        <div class="benefit">
                            <span class="benefit-icon">üîÑ</span>
                            <div class="benefit-text">
                                <strong>–õ–µ–≥–∫–∏–π –≤–æ–∑–≤—Ä–∞—Ç</strong>
                                <p>14 –¥–Ω–µ–π –Ω–∞ –≤–æ–∑–≤—Ä–∞—Ç</p>
                            </div>
                        </div>
                        <div class="benefit">
                            <span class="benefit-icon">üí≥</span>
                            <div class="benefit-text">
                                <strong>–ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ–ø–ª–∞—Ç–∞</strong>
                                <p>SSL-—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        {% else %}
            <!-- –ü—É—Å—Ç–∞—è –∫–æ—Ä–∑–∏–Ω–∞ -->
            <div class="empty-cart">
                <div class="empty-icon">üõí</div>
                <h2>–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</h2>
                <p>–î–æ–±–∞–≤—å—Ç–µ —Ç–æ–≤–∞—Ä—ã –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞, —á—Ç–æ–±—ã –æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</p>
                <a href="{% url 'appProducts:category_list' %}" class="btn btn-primary btn-lg">
                    üõçÔ∏è –ü–µ—Ä–µ–π—Ç–∏ –≤ –∫–∞—Ç–∞–ª–æ–≥
                </a>
            </div>
        {% endif %}
    </div>
</div>

<!-- JavaScript –¥–ª—è —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–π –∫–æ—Ä–∑–∏–Ω—ã -->
<script>
// –î–æ–±–∞–≤–ª—è–µ–º CSRF —Ç–æ–∫–µ–Ω –¥–ª—è AJAX –∑–∞–ø—Ä–æ—Å–æ–≤
document.addEventListener('DOMContentLoaded', function() {
    // –°–æ–∑–¥–∞–µ–º —Å–∫—Ä—ã—Ç—ã–π input —Å CSRF —Ç–æ–∫–µ–Ω–æ–º –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
    if (!document.querySelector('[name=csrfmiddlewaretoken]')) {
        const csrfToken = document.querySelector('meta[name=csrf-token]')?.getAttribute('content') || '{{ csrf_token }}';
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrfmiddlewaretoken';
        csrfInput.value = csrfToken;
        document.body.appendChild(csrfInput);
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ—Ä–∑–∏–Ω—ã
    initCart();
    updateTotals();
});

let allSelected = true;

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —á–∏—Å–µ–ª —Å –ø—Ä–æ–±–µ–ª–∞–º–∏
function formatNumber(num) {
    // –ï—Å–ª–∏ —á–∏—Å–ª–æ —Ü–µ–ª–æ–µ, –Ω–µ –¥–æ–±–∞–≤–ª—è–µ–º –¥–µ—Å—è—Ç–∏—á–Ω—ã–µ –∑–Ω–∞–∫–∏
    if (num % 1 === 0) {
        return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
    } else {
        return num.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ—Ä–∑–∏–Ω—ã
function initCart() {
    // –û–±–Ω–æ–≤–ª—è–µ–º —á–µ–∫–±–æ–∫—Å—ã
    updateCheckboxStates();
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–æ–º–æ–∫–æ–¥
    initPromoCode();
    
    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –≤—Å–µ —Ü–µ–Ω—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
    formatAllPrices();
}

// –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —Ü–µ–Ω –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
function formatAllPrices() {
    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ü–µ–Ω—ã –≤ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö —Ç–æ–≤–∞—Ä–æ–≤
    const priceElements = document.querySelectorAll('.price-value, .total-value');
    priceElements.forEach(element => {
        const text = element.textContent;
        // –£–±–∏—Ä–∞–µ–º –≤—Å–µ —Å–∏–º–≤–æ–ª—ã –∫—Ä–æ–º–µ —Ü–∏—Ñ—Ä, –∑–∞—Ç–µ–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º
        const number = parseInt(text.replace(/[^\d]/g, ''));
        if (number) {
            const formatted = formatNumber(number);
            element.textContent = text.replace(/[\d,]+/g, formatted);
        }
    });
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ç–æ–≤–∞—Ä–∞
function updateQuantity(itemId, change) {
    const qtyInput = document.getElementById(`qty-${itemId}`);
    const currentValue = parseInt(qtyInput.value);
    const newValue = Math.max(1, Math.min(100, currentValue + change));
    
    if (newValue !== currentValue) {
        qtyInput.value = newValue;
        updateQuantityInput(itemId, newValue);
    }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —á–µ—Ä–µ–∑ –∏–Ω–ø—É—Ç
function updateQuantityInput(itemId, newValue) {
    const value = Math.max(1, Math.min(100, parseInt(newValue) || 1));
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º AJAX –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    fetch(`{% url 'appProducts:update_cart' 0 %}`.replace('0', itemId), {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            'quantity': value
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateTotals();
            showNotification('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ!', 'success');
        } else {
            showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞', 'error');
    });
}

// –£–¥–∞–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã
function removeItem(itemId) {
    if (confirm('–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã?')) {
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º AJAX –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        fetch(`{% url 'appProducts:remove_from_cart' 0 %}`.replace('0', itemId), {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // –£–¥–∞–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç –∏–∑ DOM —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
                const itemElement = document.querySelector(`[data-item-id="${itemId}"]`);
                if (itemElement) {
                    itemElement.style.transform = 'translateX(-100%)';
                    itemElement.style.opacity = '0';
                    
                    setTimeout(() => {
                        itemElement.remove();
                        updateTotals();
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Å—Ç–∞–ª–∏—Å—å –ª–∏ —Ç–æ–≤–∞—Ä—ã
                        const remainingItems = document.querySelectorAll('.cart-item-modern');
                        if (remainingItems.length === 0) {
                            location.reload(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –ø–æ–∫–∞–∑–∞ –ø—É—Å—Ç–æ–π –∫–æ—Ä–∑–∏–Ω—ã
                        }
                    }, 300);
                }
                
                showNotification('–¢–æ–≤–∞—Ä —É–¥–∞–ª–µ–Ω –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã', 'success');
            } else {
                showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞', 'error');
        });
    }
}

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤—ã–±–æ—Ä–∞ –≤—Å–µ—Ö —Ç–æ–≤–∞—Ä–æ–≤
function toggleSelectAll() {
    allSelected = !allSelected;
    const checkboxes = document.querySelectorAll('.item-select');
    const button = document.querySelector('.select-all-btn .btn-text');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = allSelected;
    });
    
    button.textContent = allSelected ? '–°–Ω—è—Ç—å –≤—ã–¥–µ–ª–µ–Ω–∏–µ' : '–í—ã–¥–µ–ª–∏—Ç—å –≤—Å–µ';
    updateTotals();
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è —á–µ–∫–±–æ–∫—Å–æ–≤
function updateCheckboxStates() {
    const checkboxes = document.querySelectorAll('.item-select');
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateTotals);
    });
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏—Ç–æ–≥–æ–≤
function updateTotals() {
    const selectedItems = document.querySelectorAll('.item-select:checked');
    let totalItems = selectedItems.length;
    let totalAmount = 0;
    
    selectedItems.forEach(checkbox => {
        const itemElement = checkbox.closest('.cart-item-modern');
        const itemId = itemElement.dataset.itemId;
        const quantity = parseInt(document.getElementById(`qty-${itemId}`).value);
        const priceText = itemElement.querySelector('.price-value').textContent;
        // –£–±–∏—Ä–∞–µ–º –≤—Å–µ —Å–∏–º–≤–æ–ª—ã –∫—Ä–æ–º–µ —Ü–∏—Ñ—Ä –∏ –ø—Ä–æ–±–µ–ª–æ–≤, –∑–∞—Ç–µ–º –∑–∞–º–µ–Ω—è–µ–º –ø—Ä–æ–±–µ–ª—ã –Ω–∞ –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É
        const price = parseInt(priceText.replace(/[^\d\s]/g, '').replace(/\s/g, ''));
        totalAmount += price * quantity;
    });
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º
    document.getElementById('total-items').textContent = `${totalItems} —à—Ç.`;
    document.getElementById('subtotal').textContent = `${formatNumber(totalAmount)} ‚ÇΩ`;
    document.getElementById('final-total').textContent = `${formatNumber(totalAmount)} ‚ÇΩ`;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞
    const checkoutAmount = document.querySelector('.checkout-amount');
    if (checkoutAmount) {
        checkoutAmount.textContent = `${formatNumber(totalAmount)} ‚ÇΩ`;
    }
}

// –û—á–∏—Å—Ç–∫–∞ –∫–æ—Ä–∑–∏–Ω—ã
function clearCart() {
    if (confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—é –∫–æ—Ä–∑–∏–Ω—É? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) {
        showNotification('–ö–æ—Ä–∑–∏–Ω–∞ –æ—á–∏—â–µ–Ω–∞', 'info');
        setTimeout(() => location.reload(), 1000);
    }
}

// –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–∞
function applyPromoCode() {
    const promoInput = document.getElementById('promoCode');
    const promoCode = promoInput.value.trim();
    
    if (!promoCode) {
        showNotification('–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥', 'warning');
        return;
    }
    
    // –ò–º–∏—Ç–∞—Ü–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞
    setTimeout(() => {
        if (promoCode.toLowerCase() === 'clean10') {
            showNotification('–ü—Ä–æ–º–æ–∫–æ–¥ –ø—Ä–∏–º–µ–Ω–µ–Ω! –°–∫–∏–¥–∫–∞ 10%', 'success');
            // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Å–∫–∏–¥–∫–∏
        } else {
            showNotification('–ü—Ä–æ–º–æ–∫–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –∏—Å—Ç–µ–∫', 'error');
        }
    }, 500);
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞
function initPromoCode() {
    const promoInput = document.getElementById('promoCode');
    if (promoInput) {
        promoInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                applyPromoCode();
                }
            });
        }
}

// –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞ –ø–æ—Ç–æ–º
function saveForLater(itemId) {
    showNotification('–¢–æ–≤–∞—Ä —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–º!', 'success');
    // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ wishlist
}

// –ü–æ–∫–∞–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.innerHTML = `
        <div class="notification-content">
            <span class="notification-icon">${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è'}</span>
            <span class="notification-text">${message}</span>
        </div>
    `;
    
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: white;
        padding: 16px 20px;
        border-radius: 12px;
        box-shadow: 0 8px 24px rgba(0,0,0,0.15);
        z-index: 10000;
        transform: translateX(100%);
        transition: all 0.3s ease;
        border-left: 4px solid ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : type === 'warning' ? '#f59e0b' : '#3b82f6'};
        font-weight: 500;
        max-width: 350px;
        min-width: 250px;
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.transform = 'translateX(0)';
    }, 100);
    
    setTimeout(() => {
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

// –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ (–µ—Å–ª–∏ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ –≤ –¥—Ä—É–≥–∏—Ö –º–µ—Å—Ç–∞—Ö)
if (typeof toggleWishlist !== 'function') {
    function toggleWishlist(productId, button) {
        let wishlist = JSON.parse(localStorage.getItem('wishlist')) || [];
        const index = wishlist.indexOf(productId);
        
        if (index === -1) {
            wishlist.push(productId);
            button.classList.add('active');
            showNotification('–¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ! ‚ù§Ô∏è', 'success');
        } else {
            wishlist.splice(index, 1);
            button.classList.remove('active');
            showNotification('–¢–æ–≤–∞—Ä —É–¥–∞–ª–µ–Ω –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ', 'info');
        }
        
        localStorage.setItem('wishlist', JSON.stringify(wishlist));
    }
}
</script>
{% endblock %}