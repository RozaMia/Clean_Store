{% extends "base.html" %}
{% load static %}
{% load custom_filters %}

{% block title %}–í—Å–µ —Ç–æ–≤–∞—Ä—ã ‚Äî Clean Store{% endblock %}

{% block content %}
<div class="all-products-page">
    <div class="container">
        <!-- –•–ª–µ–±–Ω—ã–µ –∫—Ä–æ—à–∫–∏ -->
        <nav class="breadcrumb">
            <a href="{% url 'home' %}" class="breadcrumb-link">–ì–ª–∞–≤–Ω–∞—è</a>
            <span class="breadcrumb-separator">‚Üí</span>
            <span class="breadcrumb-current">–í—Å–µ —Ç–æ–≤–∞—Ä—ã</span>
        </nav>

        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
        <div class="page-header-modern">
            <div class="page-title-section">
                <h1 class="page-title-modern">üõçÔ∏è –í—Å–µ —Ç–æ–≤–∞—Ä—ã</h1>
                <p class="page-subtitle">–ù–∞–π–¥–µ–Ω–æ —Ç–æ–≤–∞—Ä–æ–≤: <span class="products-count">{{ total_products }}</span></p>
            </div>
        </div>

        <!-- –§–∏–ª—å—Ç—Ä—ã –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ -->
        <div class="filters-section-modern">
            <div class="filters-header">
                <h2 class="filters-title">–§–∏–ª—å—Ç—Ä—ã –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</h2>
                <p class="filters-subtitle">–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ –≤–∞—à–∏–º –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è–º</p>
            </div>
            
            <div class="filters-container">
                <form method="get" class="filters-form">
                    <!-- –ü–æ–∏—Å–∫ -->
                    <div class="filter-group">
                        <h3 class="filter-group-title">–ü–æ–∏—Å–∫</h3>
                        <div class="search-input-group">
                            <input type="text" name="search" value="{{ search_query }}" 
                                   placeholder="–ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤..." class="search-input">
                            <button type="submit" class="search-btn">üîç</button>
                        </div>
                    </div>

                    <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ -->
                    <div class="filter-group">
                        <h3 class="filter-group-title">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</h3>
                        <select name="category" class="filter-select" onchange="this.form.submit()">
                            <option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
                            {% for category in categories %}
                                <option value="{{ category.slug }}" 
                                        {% if current_category == category.slug %}selected{% endif %}>
                                    {{ category.title }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- –ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ -->
                    <div class="filter-group">
                        <h3 class="filter-group-title">–ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è</h3>
                        <select name="subcategory" class="filter-select" onchange="this.form.submit()">
                            <option value="">–í—Å–µ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
                            {% for subcategory in subcategories %}
                                <option value="{{ subcategory.slug }}" 
                                        {% if current_subcategory == subcategory.slug %}selected{% endif %}>
                                    {{ subcategory.title }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ -->
                    <div class="filter-group">
                        <h3 class="filter-group-title">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</h3>
                        <select name="sort" class="filter-select" onchange="this.form.submit()">
                            <option value="name" {% if current_sort == 'name' %}selected{% endif %}>–ü–æ –Ω–∞–∑–≤–∞–Ω–∏—é</option>
                            <option value="price_asc" {% if current_sort == 'price_asc' %}selected{% endif %}>–¶–µ–Ω–∞: –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é</option>
                            <option value="price_desc" {% if current_sort == 'price_desc' %}selected{% endif %}>–¶–µ–Ω–∞: –ø–æ —É–±—ã–≤–∞–Ω–∏—é</option>
                            <option value="newest" {% if current_sort == 'newest' %}selected{% endif %}>–°–Ω–∞—á–∞–ª–∞ –Ω–æ–≤—ã–µ</option>
                            <option value="popular" {% if current_sort == 'popular' %}selected{% endif %}>–ü–æ –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç–∏</option>
                        </select>
                    </div>

                    <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
                    <div class="filter-actions">
                        <button type="submit" class="apply-filters-btn">–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</button>
                        <a href="{% url 'appProducts:all_products' %}" class="clear-filters-btn">–°–±—Ä–æ—Å–∏—Ç—å</a>
                    </div>
                </form>
            </div>
        </div>

        <!-- –°–µ—Ç–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ -->
        {% if products %}
            <div class="products-grid-modern">
                {% for product in products %}
                    <div class="product-card catalog-card" data-product-id="{{ product.id }}">
                        <div class="product-image-container">
                            {% if product.images.first %}
                                <img src="{{ product.images.first.image.url }}" 
                                     alt="{{ product.name }}" 
                                     class="product-image">
                            {% else %}
                                <div class="product-image-placeholder">
                                    <span class="placeholder-icon">üì¶</span>
                                </div>
                            {% endif %}
                            
                            <!-- –ë–µ–π–¥–∂–∏ —Ç–æ–≤–∞—Ä–∞ -->
                            <div class="product-badges">
                                {% if product.is_new %}
                                    <span class="product-badge new">–ù–æ–≤–∏–Ω–∫–∞</span>
                                {% endif %}
                                {% if product.is_hit %}
                                    <span class="product-badge hit">–•–∏—Ç</span>
                                {% endif %}
                                {% if product.is_sale %}
                                    <span class="product-badge sale">–°–∫–∏–¥–∫–∞</span>
                                {% endif %}
                            </div>
                        </div>

                        <div class="product-content">
                            <div class="product-category">
                                <span class="category-icon">üìÅ</span>
                                <span class="category-path">{{ product.subcategory.category.title }} ‚Üí {{ product.subcategory.title }}</span>
                            </div>
                            
                            <h3 class="product-name">
                                <a href="{% url 'appProducts:product_detail' product.subcategory.category.slug product.subcategory.slug product.slug %}">
                                    {{ product.name }}
                                </a>
                            </h3>
                            
                            <div class="product-description">
                                <p>{{ product.description|truncatewords:15 }}</p>
                            </div>
                            
                            <div class="product-price">
                                <span class="price-current">{{ product.price|currency }}</span>
                            </div>
                            
                            <div class="product-actions">
                                <button class="action-btn wishlist-btn" onclick="toggleWishlist({{ product.id }})" title="–í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ">
                                    <span class="action-icon">‚ù§Ô∏è</span>
                                </button>
                                <button class="action-btn compare-btn" onclick="toggleCompare({{ product.id }})" title="–°—Ä–∞–≤–Ω–∏—Ç—å">
                                    <span class="action-icon">üìå</span>
                                </button>
                                <button class="action-btn quick-view-btn" onclick="quickView({{ product.id }})" title="–ë—ã—Å—Ç—Ä—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä">
                                    <span class="action-icon">üëÅÔ∏è</span>
                                </button>
                                <a href="{% url 'appProducts:add_to_cart' product.id %}" class="add-to-cart-btn" title="–í –∫–æ—Ä–∑–∏–Ω—É">
                                    <span class="action-icon">üõí</span>
                                </a>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>

            <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
            {% if page_obj.has_other_pages %}
                <div class="pagination-modern">
                    <div class="pagination-info">
                        –ü–æ–∫–∞–∑–∞–Ω–æ {{ page_obj.start_index }}‚Äì{{ page_obj.end_index }} –∏–∑ {{ page_obj.paginator.count }} —Ç–æ–≤–∞—Ä–æ–≤
                    </div>
                    
                    <div class="pagination-links">
                        {% if page_obj.has_previous %}
                            <a href="?{% if request.GET.urlencode %}{{ request.GET.urlencode }}&{% endif %}page=1" class="pagination-btn">¬´ –ü–µ—Ä–≤–∞—è</a>
                            <a href="?{% if request.GET.urlencode %}{{ request.GET.urlencode }}&{% endif %}page={{ page_obj.previous_page_number }}" class="pagination-btn">‚Äπ –ü—Ä–µ–¥—ã–¥—É—â–∞—è</a>
                        {% endif %}
                        
                        <span class="pagination-current">
                            –°—Ç—Ä–∞–Ω–∏—Ü–∞ {{ page_obj.number }} –∏–∑ {{ page_obj.paginator.num_pages }}
                        </span>
                        
                        {% if page_obj.has_next %}
                            <a href="?{% if request.GET.urlencode %}{{ request.GET.urlencode }}&{% endif %}page={{ page_obj.next_page_number }}" class="pagination-btn">–°–ª–µ–¥—É—é—â–∞—è ‚Ä∫</a>
                            <a href="?{% if request.GET.urlencode %}{{ request.GET.urlencode }}&{% endif %}page={{ page_obj.paginator.num_pages }}" class="pagination-btn">–ü–æ—Å–ª–µ–¥–Ω—è—è ¬ª</a>
                        {% endif %}
                    </div>
                </div>
            {% endif %}
        {% else %}
            <!-- –ü—É—Å—Ç–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç -->
            <div class="empty-results">
                <div class="empty-icon">üîç</div>
                <h2>–¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h2>
                <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞ –∏–ª–∏ —Ñ–∏–ª—å—Ç—Ä—ã</p>
                <a href="{% url 'appProducts:all_products' %}" class="btn btn-primary">–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —Ç–æ–≤–∞—Ä—ã</a>
            </div>
        {% endif %}
    </div>
</div>

<!-- JavaScript –¥–ª—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    initAllProducts();
});

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤—Å–µ—Ö —Ç–æ–≤–∞—Ä–æ–≤
function initAllProducts() {
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ –∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
    updateButtonStates();
    
    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –≤—Å–µ —Ü–µ–Ω—ã
    formatAllPrices();
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Å–µ—Ö —Ü–µ–Ω –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
function formatAllPrices() {
    const priceElements = document.querySelectorAll('.price-current');
    priceElements.forEach(element => {
        const text = element.textContent;
        const number = parseInt(text.replace(/[^\d\s]/g, '').replace(/\s/g, ''));
        if (number) {
            const formatted = formatNumber(number);
            element.textContent = text.replace(/[\d\s]+/g, formatted);
        }
    });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —á–∏—Å–µ–ª —Å –ø—Ä–æ–±–µ–ª–∞–º–∏
function formatNumber(num) {
    if (num % 1 === 0) {
        return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
    } else {
        return num.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
    }
}

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
function toggleWishlist(productId) {
    // –ó–¥–µ—Å—å –±—É–¥–µ—Ç –ª–æ–≥–∏–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/—É–¥–∞–ª–µ–Ω–∏—è –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
    showNotification('–¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ', 'success');
}

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
function toggleCompare(productId) {
    // –ó–¥–µ—Å—å –±—É–¥–µ—Ç –ª–æ–≥–∏–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/—É–¥–∞–ª–µ–Ω–∏—è –∏–∑ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
    showNotification('–¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω –∫ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é', 'info');
}

// –ë—ã—Å—Ç—Ä—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä
function quickView(productId) {
    // –ó–¥–µ—Å—å –±—É–¥–µ—Ç –ª–æ–≥–∏–∫–∞ –±—ã—Å—Ç—Ä–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
    showNotification('–ë—ã—Å—Ç—Ä—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä —Ç–æ–≤–∞—Ä–∞', 'info');
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–Ω–æ–ø–æ–∫
function updateButtonStates() {
    // –ó–¥–µ—Å—å –±—É–¥–µ—Ç –ª–æ–≥–∏–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–Ω–æ–ø–æ–∫
}

// –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
function showNotification(message, type = 'info') {
    // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.textContent = message;
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª–∏
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 1000;
        font-weight: 500;
        transform: translateX(100%);
        transition: transform 0.3s ease;
    `;
    
    document.body.appendChild(notification);
    
    // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è
    setTimeout(() => {
        notification.style.transform = 'translateX(0)';
    }, 100);
    
    // –£–¥–∞–ª—è–µ–º —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
    setTimeout(() => {
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => {
            document.body.removeChild(notification);
        }, 300);
    }, 3000);
}
</script>
{% endblock %}
