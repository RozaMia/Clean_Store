{% extends "base.html" %}
{% load static %}

{% block title %}{{ subcategory.title }} ‚Äî {{ category.title }} ‚Äî Clean Store{% endblock %}

{% block content %}
<div class="products-page">
    <div class="container">
        <!-- –•–ª–µ–±–Ω—ã–µ –∫—Ä–æ—à–∫–∏ -->
        <nav class="breadcrumb">
            <a href="{% url 'home' %}" class="breadcrumb-link">–ì–ª–∞–≤–Ω–∞—è</a>
            <span class="breadcrumb-separator">‚Üí</span>
            <a href="{% url 'appProducts:category_list' %}" class="breadcrumb-link">–ö–∞—Ç–∞–ª–æ–≥</a>
            <span class="breadcrumb-separator">‚Üí</span>
            <a href="{% url 'appProducts:subcategory_list' category.slug %}" class="breadcrumb-link">{{ category.title }}</a>
            <span class="breadcrumb-separator">‚Üí</span>
            <span class="breadcrumb-current">{{ subcategory.title }}</span>
        </nav>

        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ -->
        <div class="category-header">
            <div class="category-header-content">
                <h1 class="category-title">{{ subcategory.title }}</h1>
                {% if subcategory.description %}
                    <p class="category-description">{{ subcategory.description }}</p>
                {% endif %}
                <div class="category-meta">
                    <span class="subcategory-count">{{ page_obj.paginator.count }} —Ç–æ–≤–∞—Ä–æ–≤</span>
                </div>
            </div>
            {% if subcategory.image %}
                <div class="category-image">
                    <img src="{{ subcategory.image.url }}" alt="{{ subcategory.title }}">
                </div>
            {% else %}
                <div class="category-image-placeholder">
                    {% if '–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä' in subcategory.title|lower %}üóÇÔ∏è
                    {% elif '—Å–∏–∑' in subcategory.title|lower %}ü¶∫
                    {% elif '—Ö–∏–º–∏—è' in subcategory.title|lower %}üß™
                    {% elif '–∏–Ω–≤–µ–Ω—Ç–∞—Ä—å' in subcategory.title|lower %}üßπ
                    {% elif '—Å—Ä–µ–¥—Å—Ç–≤–∞' in subcategory.title|lower %}üß¥
                    {% elif '—É—Ä–Ω–∞' in subcategory.title|lower %}üóëÔ∏è
                    {% elif '—É–±–æ—Ä–∫–∞' in subcategory.title|lower %}üßΩ
                    {% else %}üìã{% endif %}
                </div>
            {% endif %}
        </div>

        <!-- –ú–æ–¥–µ—Ä–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã -->
        <section class="filters-section-modern">
            <div class="filters-header">
                <h2 class="filters-title">üéØ –§–∏–ª—å—Ç—Ä—ã —Ç–æ–≤–∞—Ä–æ–≤</h2>
                <p class="filters-subtitle">–ù–∞–π–¥–∏—Ç–µ –∏–º–µ–Ω–Ω–æ —Ç–æ, —á—Ç–æ –≤–∞–º –Ω—É–∂–Ω–æ</p>
            </div>
            <div class="filters-container">
                <div class="filter-group">
                    <h3 class="filter-group-title">–ü–æ –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç–∏</h3>
                    <div class="filter-buttons">
                        <a href="." class="filter-btn-modern {% if not request.GET.tag %}active{% endif %}">
                            <div class="filter-icon-container">
                                <span class="filter-icon">üîç</span>
                            </div>
                            <div class="filter-content">
                                <span class="filter-title">–í—Å–µ —Ç–æ–≤–∞—Ä—ã</span>
                                <span class="filter-description">–ü–æ–ª–Ω—ã–π –∫–∞—Ç–∞–ª–æ–≥</span>
                            </div>
                            <div class="filter-count">{{ page_obj.paginator.count }}</div>
                        </a>
                        <a href="?tag=new" class="filter-btn-modern {% if request.GET.tag == 'new' %}active{% endif %}">
                            <div class="filter-icon-container new">
                                <span class="filter-icon">‚ú®</span>
                            </div>
                            <div class="filter-content">
                                <span class="filter-title">–ù–æ–≤–∏–Ω–∫–∏</span>
                                <span class="filter-description">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è</span>
                            </div>
                            <div class="filter-count">{% with new_count=products|length %}{{ new_count }}{% endwith %}</div>
                        </a>
                        <a href="?tag=hit" class="filter-btn-modern {% if request.GET.tag == 'hit' %}active{% endif %}">
                            <div class="filter-icon-container hit">
                                <span class="filter-icon">üî•</span>
                            </div>
                            <div class="filter-content">
                                <span class="filter-title">–•–∏—Ç—ã –ø—Ä–æ–¥–∞–∂</span>
                                <span class="filter-description">–°–∞–º—ã–µ –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ</span>
                            </div>
                            <div class="filter-count">{% with hit_count=products|length %}{{ hit_count }}{% endwith %}</div>
                        </a>
                        <a href="?tag=sale" class="filter-btn-modern {% if request.GET.tag == 'sale' %}active{% endif %}">
                            <div class="filter-icon-container sale">
                                <span class="filter-icon">üí∞</span>
                            </div>
                            <div class="filter-content">
                                <span class="filter-title">–†–∞—Å–ø—Ä–æ–¥–∞–∂–∞</span>
                                <span class="filter-description">–í—ã–≥–æ–¥–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è</span>
                            </div>
                            <div class="filter-count">{% with sale_count=products|length %}{{ sale_count }}{% endwith %}</div>
                        </a>
                    </div>
                </div>
            </div>
        </section>

        <!-- –¢–æ–≤–∞—Ä—ã -->
        <section class="products-section">
            <div class="section-header">
                <h2 class="section-title">–¢–æ–≤–∞—Ä—ã</h2>
                <span class="products-count">–ù–∞–π–¥–µ–Ω–æ: {{ page_obj.paginator.count }} —Ç–æ–≤–∞—Ä–æ–≤</span>
            </div>
            
            <div class="products-grid">
                {% for product in page_obj %}
                    <div class="product-card catalog-card" data-product-id="{{ product.id }}">
                        <a href="{% url 'appProducts:product_detail' category.slug subcategory.slug product.slug %}" class="category-link-full">
                            <div class="category-image-container">
                                {% if product.main_image %}
                                    <img src="{{ product.main_image.url }}" alt="{{ product.name }}" class="category-image">
                                {% else %}
                                    <div class="category-placeholder">
                                        <span class="placeholder-emoji">üßΩ</span>
                                        <div class="placeholder-text">
                                            –ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                                        </div>
                                    </div>
                                {% endif %}
                                
                                <!-- –ë–µ–π–¥–∂–∏ -->
                                <div class="product-badges">
                                    {% if product.is_new %}
                                        <span class="product-badge new">–ù–æ–≤–∏–Ω–∫–∞</span>
                                    {% endif %}
                                    {% if product.is_hit %}
                                        <span class="product-badge hit">–•–∏—Ç</span>
                                    {% endif %}
                                    {% if product.is_sale %}
                                        <span class="product-badge sale">–°–∫–∏–¥–∫–∞</span>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="category-content">
                                <h3 class="category-title">{{ product.name }}</h3>
                                {% if product.description %}
                                    <p class="category-description">{{ product.description|truncatewords:8 }}</p>
                                {% endif %}
                                <div class="category-meta">
                                    <div class="product-price">{{ product.price }}</div>
                                    <div class="category-action">
                                        <span class="category-btn">
                                            –ü–æ–¥—Ä–æ–±–Ω–µ–µ ‚Üí
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </a>
                        
                        <!-- –î–µ–π—Å—Ç–≤–∏—è —Å —Ç–æ–≤–∞—Ä–æ–º -->
                        <div class="product-card-actions">
                            <button class="action-btn-card wishlist" onclick="toggleWishlist({{ product.id }}, this)" title="–î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ">
                                <span class="action-icon">‚ù§Ô∏è</span>
                            </button>
                            <button class="action-btn-card compare" onclick="toggleCompare({{ product.id }}, this)" title="–°—Ä–∞–≤–Ω–∏—Ç—å —Ç–æ–≤–∞—Ä">
                                <span class="action-icon">‚öñÔ∏è</span>
                            </button>
                            {% if user.is_authenticated %}
                                <form method="post" action="{% url 'appProducts:add_to_cart' product.id %}" class="quick-cart-form">
                                    {% csrf_token %}
                                    <input type="hidden" name="quantity" value="1">
                                    <button type="submit" class="action-btn-card cart" title="–ë—ã—Å—Ç—Ä–æ –≤ –∫–æ—Ä–∑–∏–Ω—É">
                                        <span class="action-icon">üõí</span>
                                    </button>
                                </form>
                            {% endif %}
                        </div>
                    </div>
                {% empty %}
                    <div class="empty-state">
                        <div class="empty-icon">üì¶</div>
                        <h3>–¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
                        <p>–í –¥–∞–Ω–Ω–æ–π –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–æ–∫–∞ –Ω–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤</p>
                        <a href="{% url 'appProducts:subcategory_list' category.slug %}" class="btn btn-primary">
                            –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
                        </a>
                    </div>
                {% endfor %}
            </div>
        </section>

        <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
        {% if page_obj.has_other_pages %}
        <section class="pagination-section">
            <div class="pagination">
                {% if page_obj.has_previous %}
                    <a href="?page=1{% if request.GET.tag %}&tag={{ request.GET.tag }}{% endif %}" class="pagination-btn">
                        ‚ü®‚ü® –ü–µ—Ä–≤–∞—è
                    </a>
                    <a href="?page={{ page_obj.previous_page_number }}{% if request.GET.tag %}&tag={{ request.GET.tag }}{% endif %}" class="pagination-btn">
                        ‚ü® –ü—Ä–µ–¥—ã–¥—É—â–∞—è
                    </a>
                {% endif %}

                <span class="pagination-current">
                    –°—Ç—Ä–∞–Ω–∏—Ü–∞ {{ page_obj.number }} –∏–∑ {{ page_obj.paginator.num_pages }}
                </span>

                {% if page_obj.has_next %}
                    <a href="?page={{ page_obj.next_page_number }}{% if request.GET.tag %}&tag={{ request.GET.tag }}{% endif %}" class="pagination-btn">
                        –°–ª–µ–¥—É—é—â–∞—è ‚ü©
                    </a>
                    <a href="?page={{ page_obj.paginator.num_pages }}{% if request.GET.tag %}&tag={{ request.GET.tag }}{% endif %}" class="pagination-btn">
                        –ü–æ—Å–ª–µ–¥–Ω—è—è ‚ü©‚ü©
                    </a>
                {% endif %}
            </div>
        </section>
        {% endif %}
    </div>
</div>

<!-- JavaScript –¥–ª—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è localStorage –¥–ª—è –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ –∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
    if (!localStorage.getItem('wishlist')) {
        localStorage.setItem('wishlist', JSON.stringify([]));
    }
    if (!localStorage.getItem('compare')) {
        localStorage.setItem('compare', JSON.stringify([]));
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
    updateButtonStates();
});

// –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
function toggleWishlist(productId, button) {
    let wishlist = JSON.parse(localStorage.getItem('wishlist')) || [];
    const index = wishlist.indexOf(productId);
    
    if (index === -1) {
        wishlist.push(productId);
        button.classList.add('active');
        showNotification('–¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ! ‚ù§Ô∏è', 'success');
    } else {
        wishlist.splice(index, 1);
        button.classList.remove('active');
        showNotification('–¢–æ–≤–∞—Ä —É–¥–∞–ª–µ–Ω –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ', 'info');
    }
    
    localStorage.setItem('wishlist', JSON.stringify(wishlist));
    updateWishlistCount();
}

// –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
function toggleCompare(productId, button) {
    let compare = JSON.parse(localStorage.getItem('compare')) || [];
    const index = compare.indexOf(productId);
    
    if (index === -1) {
        if (compare.length >= 4) {
            showNotification('–ú–æ–∂–Ω–æ —Å—Ä–∞–≤–Ω–∏–≤–∞—Ç—å –Ω–µ –±–æ–ª–µ–µ 4 —Ç–æ–≤–∞—Ä–æ–≤', 'warning');
            return;
        }
        compare.push(productId);
        button.classList.add('active');
        showNotification('–¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω –∫ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é! ‚öñÔ∏è', 'success');
    } else {
        compare.splice(index, 1);
        button.classList.remove('active');
        showNotification('–¢–æ–≤–∞—Ä —É–¥–∞–ª–µ–Ω –∏–∑ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è', 'info');
    }
    
    localStorage.setItem('compare', JSON.stringify(compare));
    updateCompareCount();
}


// –û–±–Ω–æ–≤–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–æ–∫
function updateButtonStates() {
    const wishlist = JSON.parse(localStorage.getItem('wishlist')) || [];
    const compare = JSON.parse(localStorage.getItem('compare')) || [];
    
    document.querySelectorAll('.wishlist').forEach(btn => {
        const productCard = btn.closest('.product-card');
        if (productCard) {
            const productId = parseInt(productCard.dataset.productId);
            if (wishlist.includes(productId)) {
                btn.classList.add('active');
            }
        }
    });
    
    document.querySelectorAll('.compare').forEach(btn => {
        const productCard = btn.closest('.product-card');
        if (productCard) {
            const productId = parseInt(productCard.dataset.productId);
            if (compare.includes(productId)) {
                btn.classList.add('active');
            }
        }
    });
}

// –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.classList.add('show');
    }, 100);
    
    setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

// –û–±–Ω–æ–≤–∏—Ç—å —Å—á–µ—Ç—á–∏–∫–∏
function updateWishlistCount() {
    const wishlist = JSON.parse(localStorage.getItem('wishlist')) || [];
    // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å —Å—á–µ—Ç—á–∏–∫ –≤ —à–∞–ø–∫–µ —Å–∞–π—Ç–∞
}

function updateCompareCount() {
    const compare = JSON.parse(localStorage.getItem('compare')) || [];
    // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å —Å—á–µ—Ç—á–∏–∫ –≤ —à–∞–ø–∫–µ —Å–∞–π—Ç–∞
}
</script>
{% endblock %}