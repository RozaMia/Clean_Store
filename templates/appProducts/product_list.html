{% extends "base.html" %}
{% load static %}

{% block title %}{{ subcategory.title }} ‚Äî {{ category.title }} ‚Äî Clean Store{% endblock %}

{% block content %}
<div class="products-page">
    <div class="container">
        <!-- –•–ª–µ–±–Ω—ã–µ –∫—Ä–æ—à–∫–∏ -->
        <nav class="breadcrumb">
            <a href="{% url 'home' %}" class="breadcrumb-link">–ì–ª–∞–≤–Ω–∞—è</a>
            <span class="breadcrumb-separator">‚Üí</span>
            <a href="{% url 'appProducts:category_list' %}" class="breadcrumb-link">–ö–∞—Ç–∞–ª–æ–≥</a>
            <span class="breadcrumb-separator">‚Üí</span>
            <a href="{% url 'appProducts:subcategory_list' category.slug %}" class="breadcrumb-link">{{ category.title }}</a>
            <span class="breadcrumb-separator">‚Üí</span>
            <span class="breadcrumb-current">{{ subcategory.title }}</span>
        </nav>

        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ -->
        <div class="category-header">
            <div class="category-header-content">
                <h1 class="category-title">{{ subcategory.title }}</h1>
                {% if subcategory.description %}
                    <p class="category-description">{{ subcategory.description }}</p>
                {% endif %}
                <div class="category-meta">
                    <span class="subcategory-count">{{ page_obj.paginator.count }} —Ç–æ–≤–∞—Ä–æ–≤</span>
                </div>
            </div>
            {% if subcategory.image %}
                <div class="category-image">
                    <img src="{{ subcategory.image.url }}" alt="{{ subcategory.title }}">
                </div>
            {% else %}
                <div class="category-image-placeholder">
                    {% if '–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä' in subcategory.title|lower %}üóÇÔ∏è
                    {% elif '—Å–∏–∑' in subcategory.title|lower %}ü¶∫
                    {% elif '—Ö–∏–º–∏—è' in subcategory.title|lower %}üß™
                    {% elif '–∏–Ω–≤–µ–Ω—Ç–∞—Ä—å' in subcategory.title|lower %}üßπ
                    {% elif '—Å—Ä–µ–¥—Å—Ç–≤–∞' in subcategory.title|lower %}üß¥
                    {% elif '—É—Ä–Ω–∞' in subcategory.title|lower %}üóëÔ∏è
                    {% elif '—É–±–æ—Ä–∫–∞' in subcategory.title|lower %}üßΩ
                    {% else %}üìã{% endif %}
                </div>
            {% endif %}
        </div>

        <!-- –ú–æ–¥–µ—Ä–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã -->
        <section class="filters-section-modern">
            <div class="filters-header">
                <h2 class="filters-title">üéØ –§–∏–ª—å—Ç—Ä—ã —Ç–æ–≤–∞—Ä–æ–≤</h2>
                <p class="filters-subtitle">–ù–∞–π–¥–∏—Ç–µ –∏–º–µ–Ω–Ω–æ —Ç–æ, —á—Ç–æ –≤–∞–º –Ω—É–∂–Ω–æ</p>
            </div>
            <div class="filters-container">
                <div class="filter-group">
                    <h3 class="filter-group-title">–ü–æ –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç–∏</h3>
                    <div class="filter-buttons">
                        <a href="." class="filter-btn-modern {% if not request.GET.tag %}active{% endif %}">
                            <div class="filter-icon-container">
                                <span class="filter-icon">üîç</span>
                            </div>
                            <div class="filter-content">
                                <span class="filter-title">–í—Å–µ —Ç–æ–≤–∞—Ä—ã</span>
                                <span class="filter-description">–ü–æ–ª–Ω—ã–π –∫–∞—Ç–∞–ª–æ–≥</span>
                            </div>
                            <div class="filter-count">{{ page_obj.paginator.count }}</div>
                        </a>
                        <a href="?tag=new" class="filter-btn-modern {% if request.GET.tag == 'new' %}active{% endif %}">
                            <div class="filter-icon-container new">
                                <span class="filter-icon">‚ú®</span>
                            </div>
                            <div class="filter-content">
                                <span class="filter-title">–ù–æ–≤–∏–Ω–∫–∏</span>
                                <span class="filter-description">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è</span>
                            </div>
                            <div class="filter-count">{% with new_count=products|length %}{{ new_count }}{% endwith %}</div>
                        </a>
                        <a href="?tag=hit" class="filter-btn-modern {% if request.GET.tag == 'hit' %}active{% endif %}">
                            <div class="filter-icon-container hit">
                                <span class="filter-icon">üî•</span>
                            </div>
                            <div class="filter-content">
                                <span class="filter-title">–•–∏—Ç—ã –ø—Ä–æ–¥–∞–∂</span>
                                <span class="filter-description">–°–∞–º—ã–µ –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ</span>
                            </div>
                            <div class="filter-count">{% with hit_count=products|length %}{{ hit_count }}{% endwith %}</div>
                        </a>
                        <a href="?tag=sale" class="filter-btn-modern {% if request.GET.tag == 'sale' %}active{% endif %}">
                            <div class="filter-icon-container sale">
                                <span class="filter-icon">üí∞</span>
                            </div>
                            <div class="filter-content">
                                <span class="filter-title">–†–∞—Å–ø—Ä–æ–¥–∞–∂–∞</span>
                                <span class="filter-description">–í—ã–≥–æ–¥–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è</span>
                            </div>
                            <div class="filter-count">{% with sale_count=products|length %}{{ sale_count }}{% endwith %}</div>
                        </a>
                    </div>
                </div>
            </div>
        </section>

        <!-- –¢–æ–≤–∞—Ä—ã -->
        <section class="products-section">
            <div class="section-header">
                <h2 class="section-title">–¢–æ–≤–∞—Ä—ã</h2>
                <span class="products-count">–ù–∞–π–¥–µ–Ω–æ: {{ page_obj.paginator.count }} —Ç–æ–≤–∞—Ä–æ–≤</span>
            </div>
            
            <div class="products-grid-modern">
                {% for product in page_obj %}
                    <article class="product-card-modern" data-product-id="{{ product.id }}">
                        <div class="product-image-wrapper">
                            <a href="{% url 'appProducts:product_detail' category.slug subcategory.slug product.slug %}" class="product-link">
                                {% if product.main_image %}
                                    <img src="{{ product.main_image.url }}" alt="{{ product.name }}" class="product-image-modern" loading="lazy">
                                {% else %}
                                    <div class="product-image-placeholder-modern">
                                        <div class="placeholder-icon">üßΩ</div>
                                        <span class="placeholder-text-modern">–ù–µ—Ç —Ñ–æ—Ç–æ</span>
                                    </div>
                                {% endif %}
                            </a>
                            
                            <!-- –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –±–µ–π–¥–∂–∏ -->
                            <div class="product-badges-modern">
                                {% if product.is_new %}
                                    <span class="product-badge-modern new">
                                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                                        </svg>
                                        –ù–æ–≤–∏–Ω–∫–∞
                                    </span>
                                {% endif %}
                                {% if product.is_hit %}
                                    <span class="product-badge-modern hit">
                                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                                            <circle cx="12" cy="12" r="4"/>
                                        </svg>
                                        –•–∏—Ç
                                    </span>
                                {% endif %}
                                {% if product.is_sale %}
                                    <span class="product-badge-modern sale">
                                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M21 12a9 9 0 1 1-6.219-8.56"/>
                                            <path d="M13 2L3 14l6 6 10-10-6-8z"/>
                                        </svg>
                                        –°–∫–∏–¥–∫–∞
                                    </span>
                                {% endif %}
                            </div>
                        </div>

                        <div class="product-content-modern">
                            <div class="product-category-modern">
                                <span class="category-text">{{ category.title }}</span>
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M9 18l6-6-6-6"/>
                                </svg>
                                <span class="subcategory-text">{{ subcategory.title }}</span>
                            </div>
                            
                            <h3 class="product-title-modern">
                                <a href="{% url 'appProducts:product_detail' category.slug subcategory.slug product.slug %}">
                                    {{ product.name }}
                                </a>
                            </h3>
                            
                            {% if product.description %}
                                <p class="product-description-modern">{{ product.description|truncatechars:120 }}</p>
                            {% endif %}
                            
                            <div class="product-footer-modern">
                                <div class="product-price-section-modern" style="padding: 12px 16px !important; min-width: 120px !important; max-width: 140px !important;">
                                    <div class="product-price-display" style="color: #0066cc !important; font-size: 18px !important; font-weight: bold !important; line-height: 1.2 !important; word-break: break-all !important;">
                                        {{ product.price|cut:",00" }}
                                    </div>
                                    <div class="price-unit" style="color: #6b7280 !important; font-size: 12px !important; margin-top: 4px !important;">–ó–ê –®–¢.</div>
                                </div>
                                
                                <div class="product-actions-modern">
                                    <!-- –ö–Ω–æ–ø–∫–∞ "–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ç–æ–≤–∞—Ä" –¥–ª—è –≤—Å–µ—Ö -->
                                    <a href="{% url 'appProducts:product_detail' category.slug subcategory.slug product.slug %}" class="view-product-btn-modern" title="–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ç–æ–≤–∞—Ä">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                            <circle cx="12" cy="12" r="3"/>
                                        </svg>
                                        –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å
                                    </a>
                                    
                                    {% if user.is_authenticated %}
                                        <!-- –ö–Ω–æ–ø–∫–∞ "–í –∫–æ—Ä–∑–∏–Ω—É" –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö -->
                                        <button class="add-to-cart-btn-modern" onclick="addToCartModern({{ product.id }}, this)" title="–í –∫–æ—Ä–∑–∏–Ω—É">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <circle cx="8" cy="21" r="1"/>
                                                <circle cx="19" cy="21" r="1"/>
                                                <path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12"/>
                                            </svg>
                                            –í –∫–æ—Ä–∑–∏–Ω—É
                                        </button>
                                    {% else %}
                                        <!-- –ö–Ω–æ–ø–∫–∞ "–í–æ–π—Ç–∏" –¥–ª—è –Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö -->
                                        <a href="{% url 'login' %}" class="login-btn-modern" title="–í–æ–π—Ç–∏ –¥–ª—è –ø–æ–∫—É–ø–∫–∏">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/>
                                                <polyline points="10,17 15,12 10,7"/>
                                                <line x1="15" y1="12" x2="3" y2="12"/>
                                            </svg>
                                            –í–æ–π—Ç–∏
                                        </a>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </article>
                {% empty %}
                    <div class="empty-state">
                        <div class="empty-icon">üì¶</div>
                        <h3>–¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
                        <p>–í –¥–∞–Ω–Ω–æ–π –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–æ–∫–∞ –Ω–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤</p>
                        <a href="{% url 'appProducts:subcategory_list' category.slug %}" class="btn btn-primary">
                            –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
                        </a>
                    </div>
                {% endfor %}
            </div>
        </section>

        <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
        {% if page_obj.has_other_pages %}
        <section class="pagination-section">
            <div class="pagination">
                {% if page_obj.has_previous %}
                    <a href="?page=1{% if request.GET.tag %}&tag={{ request.GET.tag }}{% endif %}" class="pagination-btn">
                        ‚ü®‚ü® –ü–µ—Ä–≤–∞—è
                    </a>
                    <a href="?page={{ page_obj.previous_page_number }}{% if request.GET.tag %}&tag={{ request.GET.tag }}{% endif %}" class="pagination-btn">
                        ‚ü® –ü—Ä–µ–¥—ã–¥—É—â–∞—è
                    </a>
                {% endif %}

                <span class="pagination-current">
                    –°—Ç—Ä–∞–Ω–∏—Ü–∞ {{ page_obj.number }} –∏–∑ {{ page_obj.paginator.num_pages }}
                </span>

                {% if page_obj.has_next %}
                    <a href="?page={{ page_obj.next_page_number }}{% if request.GET.tag %}&tag={{ request.GET.tag }}{% endif %}" class="pagination-btn">
                        –°–ª–µ–¥—É—é—â–∞—è ‚ü©
                    </a>
                    <a href="?page={{ page_obj.paginator.num_pages }}{% if request.GET.tag %}&tag={{ request.GET.tag }}{% endif %}" class="pagination-btn">
                        –ü–æ—Å–ª–µ–¥–Ω—è—è ‚ü©‚ü©
                    </a>
                {% endif %}
            </div>
        </section>
        {% endif %}
    </div>
</div>

<!-- JavaScript –¥–ª—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Ç–æ–≤–∞—Ä–æ–≤
    console.log('–°—Ç—Ä–∞–Ω–∏—Ü–∞ —Ç–æ–≤–∞—Ä–æ–≤ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
});

// –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.classList.add('show');
    }, 100);
    
    setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –∫–æ—Ä–∑–∏–Ω—É –¥–ª—è —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫
function addToCartModern(productId, element) {
    const originalText = element.innerHTML;
    
    // –ê–Ω–∏–º–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏
    element.innerHTML = `
        <div class="loading-spinner-modern">
            <div class="spinner"></div>
        </div>
        –î–æ–±–∞–≤–ª—è–µ–º...
    `;
    element.disabled = true;
    
    // –†–µ–∞–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å –∫ —Å–µ—Ä–≤–µ—Ä—É
    fetch(`/products/add-to-cart/${productId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': getCsrfTokenModern()
        },
        body: 'quantity=1'
    })
    .then(response => {
        if (response.ok) {
            return response.json();
        } else if (response.status === 302 || response.status === 401) {
            // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤—Ö–æ–¥–∞
            window.location.href = '/login/';
            return;
        }
        throw new Error('Network response was not ok');
    })
    .then(data => {
        if (data) {
            element.innerHTML = `
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="20,6 9,17 4,12"/>
                </svg>
                –î–æ–±–∞–≤–ª–µ–Ω–æ!
            `;
            element.style.background = 'linear-gradient(135deg, #10b981, #34d399)';
            
            showNotification('–¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ—Ä–∑–∏–Ω—É!', 'success');
            
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π –≤–∏–¥ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
                element.innerHTML = originalText;
                element.style.background = '';
                element.disabled = false;
            }, 2000);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        element.innerHTML = originalText;
        element.disabled = false;
        showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞', 'error');
    });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è CSRF —Ç–æ–∫–µ–Ω–∞
function getCsrfTokenModern() {
    const token = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
    if (token) return token;
    
    // –ü–æ–ø—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –∏–∑ cookies
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
        const [name, value] = cookie.trim().split('=');
        if (name === 'csrftoken') {
            return decodeURIComponent(value);
        }
    }
    return '';
}

</script>
{% endblock %}